/** ****************************************************************************
 * Spine Runtimes License Agreement
 * Last updated July 28, 2023. Replaces all prior versions.
 *
 * Copyright (c) 2013-2023, Esoteric Software LLC
 *
 * Integration of the Spine Runtimes into software or otherwise creating
 * derivative works of the Spine Runtimes is permitted under the terms and
 * conditions of Section 2 of the Spine Editor License Agreement:
 * http://esotericsoftware.com/spine-editor-license
 *
 * Otherwise, it is permitted to integrate the Spine Runtimes into software or
 * otherwise create derivative works of the Spine Runtimes (collectively,
 * "Products"), provided that each user of the Products must obtain their own
 * Spine Editor license and redistribution of the Products in any form must
 * include this license and copyright notice.
 *
 * THE SPINE RUNTIMES ARE PROVIDED BY ESOTERIC SOFTWARE LLC "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL ESOTERIC SOFTWARE LLC BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES,
 * BUSINESS INTERRUPTION, OR LOSS OF USE, DATA, OR PROFITS) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THE
 * SPINE RUNTIMES, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *****************************************************************************/
import { checkExtension, DOMAdapter, extensions, ExtensionType, LoaderParserPriority, path, Resolver, TextureSource } from 'pixi.js';
import { SpineTexture } from '../SpineTexture.js';
import { TextureAtlas } from '@esotericsoftware/spine-core';
const spineTextureAtlasLoader = {
    extension: ExtensionType.Asset,
    resolver: {
        test: (value) => checkExtension(value, ".atlas"),
        parse: (value) => {
            const split = value.split('.');
            return {
                resolution: parseFloat(Resolver.RETINA_PREFIX?.exec(value)?.[1] ?? '1'),
                format: split[split.length - 2],
                src: value,
            };
        },
    },
    loader: {
        extension: {
            type: ExtensionType.LoadParser,
            priority: LoaderParserPriority.Normal,
            name: 'spineTextureAtlasLoader',
        },
        test(url) {
            return checkExtension(url, '.atlas');
        },
        async load(url) {
            const response = await DOMAdapter.get().fetch(url);
            const txt = await response.text();
            return txt;
        },
        testParse(asset, options) {
            const isExtensionRight = checkExtension(options.src, '.atlas');
            const isString = typeof asset === 'string';
            return Promise.resolve(isExtensionRight && isString);
        },
        unload(atlas) {
            atlas.dispose();
        },
        async parse(asset, options, loader) {
            const metadata = options.data || {};
            let basePath = path.dirname(options.src);
            if (basePath && basePath.lastIndexOf('/') !== basePath.length - 1) {
                basePath += '/';
            }
            // Retval is going to be a texture atlas. However we need to wait for it's callback to resolve this promise.
            const retval = new TextureAtlas(asset);
            // If the user gave me only one texture, that one is assumed to be the "first" texture in the atlas
            if (metadata.images instanceof TextureSource || typeof metadata.images === 'string') {
                const pixiTexture = metadata.images;
                metadata.images = {};
                metadata.images[retval.pages[0].name] = pixiTexture;
            }
            // we will wait for all promises for the textures at the same time at the end.
            const textureLoadingPromises = [];
            // fill the pages
            for (const page of retval.pages) {
                const pageName = page.name;
                const providedPage = metadata?.images ? metadata.images[pageName] : undefined;
                if (providedPage instanceof TextureSource) {
                    page.setTexture(SpineTexture.from(providedPage));
                }
                else {
                    // eslint-disable-next-line max-len
                    const url = providedPage ?? path.normalize([...basePath.split(path.sep), pageName].join(path.sep));
                    const assetsToLoadIn = {
                        src: url,
                        data: {
                            ...metadata.imageMetadata,
                            alphaMode: page.pma ? 'premultiplied-alpha' : 'premultiply-alpha-on-upload'
                        }
                    };
                    const pixiPromise = loader.load(assetsToLoadIn).then((texture) => {
                        page.setTexture(SpineTexture.from(texture.source));
                    });
                    textureLoadingPromises.push(pixiPromise);
                }
            }
            await Promise.all(textureLoadingPromises);
            return retval;
        },
    },
};
extensions.add(spineTextureAtlasLoader);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXRsYXNMb2FkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXNzZXRzL2F0bGFzTG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7K0VBMkIrRTtBQUUvRSxPQUFPLEVBQ04sY0FBYyxFQUNkLFVBQVUsRUFDVixVQUFVLEVBQ1YsYUFBYSxFQUNiLG9CQUFvQixFQUNwQixJQUFJLEVBQ0osUUFBUSxFQUNSLGFBQWEsRUFDYixNQUFNLFNBQVMsQ0FBQztBQUNqQixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDbEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBTTVELE1BQU0sdUJBQXVCLEdBQWlFO0lBQzdGLFNBQVMsRUFBRSxhQUFhLENBQUMsS0FBSztJQUU5QixRQUFRLEVBQUU7UUFDVCxJQUFJLEVBQUUsQ0FBQyxLQUFhLEVBQVcsRUFBRSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDO1FBQ2pFLEtBQUssRUFBRSxDQUFDLEtBQWEsRUFBbUIsRUFBRTtZQUN6QyxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRS9CLE9BQU87Z0JBQ04sVUFBVSxFQUFFLFVBQVUsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQztnQkFDdkUsTUFBTSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztnQkFDL0IsR0FBRyxFQUFFLEtBQUs7YUFDVixDQUFDO1FBQ0gsQ0FBQztLQUNEO0lBRUQsTUFBTSxFQUFFO1FBQ1AsU0FBUyxFQUFFO1lBQ1YsSUFBSSxFQUFFLGFBQWEsQ0FBQyxVQUFVO1lBQzlCLFFBQVEsRUFBRSxvQkFBb0IsQ0FBQyxN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QUcsRUFBRSxHQUFHO3dCQUNSLElBQUksRUFBRTs0QkFDTCxHQUFHLFFBQVEsQ0FBQyxhQUFhOzRCQUN6QixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLDZCQUE2Qjt5QkFDM0U7cUJBQ0QsQ0FBQztvQkFFRixNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFVLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO3dCQUN6RSxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7b0JBQ3BELENBQUMsQ0FBQyxDQUFDO29CQUVILHNCQUFzQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDMUMsQ0FBQztZQUNGLENBQUM7WUFFRCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztZQUUxQyxPQUFPLE1BQU0sQ0FBQztRQUNmLENBQUM7S0FDRDtDQUMrRCxDQUFDO0FBRWxFLFVBQVUsQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqXG4gKiBTcGluZSBSdW50aW1lcyBMaWNlbnNlIEFncmVlbWVudFxuICogTGFzdCB1cGRhdGVkIEp1bHkgMjgsIDIwMjMuIFJlcGxhY2VzIGFsbCBwcmlvciB2ZXJzaW9ucy5cbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTMtMjAyMywgRXNvdGVyaWMgU29mdHdhcmUgTExDXG4gKlxuICogSW50ZWdyYXRpb24gb2YgdGhlIFNwaW5lIFJ1bnRpbWVzIGludG8gc29mdHdhcmUgb3Igb3RoZXJ3aXNlIGNyZWF0aW5nXG4gKiBkZXJpdmF0aXZlIHdvcmtzIG9mIHRoZSBTcGluZSBSdW50aW1lcyBpcyBwZXJtaXR0ZWQgdW5kZXIgdGhlIHRlcm1zIGFuZFxuICogY29uZGl0aW9ucyBvZiBTZWN0aW9uIDIgb2YgdGhlIFNwaW5lIEVkaXRvciBMaWNlbnNlIEFncmVlbWVudDpcbiAqIGh0dHA6Ly9lc290ZXJpY3NvZnR3YXJlLmNvbS9zcGluZS1lZGl0b3ItbGljZW5zZVxuICpcbiAqIE90aGVyd2lzZSwgaXQgaXMgcGVybWl0dGVkIHRvIGludGVncmF0ZSB0aGUgU3BpbmUgUnVudGltZXMgaW50byBzb2Z0d2FyZSBvclxuICogb3RoZXJ3aXNlIGNyZWF0ZSBkZXJpdmF0aXZlIHdvcmtzIG9mIHRoZSBTcGluZSBSdW50aW1lcyAoY29sbGVjdGl2ZWx5LFxuICogXCJQcm9kdWN0c1wiKSwgcHJvdmlkZWQgdGhhdCBlYWNoIHVzZXIgb2YgdGhlIFByb2R1Y3RzIG11c3Qgb2J0YWluIHRoZWlyIG93blxuICogU3BpbmUgRWRpdG9yIGxpY2Vuc2UgYW5kIHJlZGlzdHJpYnV0aW9uIG9mIHRoZSBQcm9kdWN0cyBpbiBhbnkgZm9ybSBtdXN0XG4gKiBpbmNsdWRlIHRoaXMgbGljZW5zZSBhbmQgY29weXJpZ2h0IG5vdGljZS5cbiAqXG4gKiBUSEUgU1BJTkUgUlVOVElNRVMgQVJFIFBST1ZJREVEIEJZIEVTT1RFUklDIFNPRlRXQVJFIExMQyBcIkFTIElTXCIgQU5EIEFOWVxuICogRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgRVNPVEVSSUMgU09GVFdBUkUgTExDIEJFIExJQUJMRSBGT1IgQU5ZXG4gKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFU1xuICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTLFxuICogQlVTSU5FU1MgSU5URVJSVVBUSU9OLCBPUiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUykgSE9XRVZFUiBDQVVTRUQgQU5EXG4gKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVFxuICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GIFRIRVxuICogU1BJTkUgUlVOVElNRVMsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5cbmltcG9ydCB7XG5cdGNoZWNrRXh0ZW5zaW9uLFxuXHRET01BZGFwdGVyLFxuXHRleHRlbnNpb25zLFxuXHRFeHRlbnNpb25UeXBlLFxuXHRMb2FkZXJQYXJzZXJQcmlvcml0eSxcblx0cGF0aCxcblx0UmVzb2x2ZXIsXG5cdFRleHR1cmVTb3VyY2Vcbn0gZnJvbSAncGl4aS5qcyc7XG5pbXBvcnQgeyBTcGluZVRleHR1cmUgfSBmcm9tICcuLi9TcGluZVRleHR1cmUuanMnO1xuaW1wb3J0IHsgVGV4dHVyZUF0bGFzIH0gZnJvbSAnQGVzb3Rlcmljc29mdHdhcmUvc3BpbmUtY29yZSc7XG5cbmltcG9ydCB0eXBlIHsgQXNzZXRFeHRlbnNpb24sIExvYWRlciwgUmVzb2x2ZWRBc3NldCwgVGV4dHVyZSwgVW5yZXNvbHZlZEFzc2V0IH0gZnJvbSAncGl4aS5qcyc7XG5cbnR5cGUgUmF3QXRsYXMgPSBzdHJpbmc7XG5cbmNvbnN0IHNwaW5lVGV4dHVyZUF0bGFzTG9hZGVyOiBBc3NldEV4dGVuc2lvbjxSYXdBdGxhcyB8IFRleHR1cmVBdGxhcywgSVNwaW5lQXRsYXNNZXRhZGF0YT4gPSB7XG5cdGV4dGVuc2lvbjogRXh0ZW5zaW9uVHlwZS5Bc3NldCxcblxuXHRyZXNvbHZlcjoge1xuXHRcdHRlc3Q6ICh2YWx1ZTogc3RyaW5nKTogYm9vbGVhbiA9PiBjaGVja0V4dGVuc2lvbih2YWx1ZSwgXCIuYXRsYXNcIiksXG5cdFx0cGFyc2U6ICh2YWx1ZTogc3RyaW5nKTogVW5yZXNvbHZlZEFzc2V0ID0+IHtcblx0XHRcdGNvbnN0IHNwbGl0ID0gdmFsdWUuc3BsaXQoJy4nKTtcblxuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0cmVzb2x1dGlvbjogcGFyc2VGbG9hdChSZXNvbHZlci5SRVRJTkFfUFJFRklYPy5leGVjKHZhbHVlKT8uWzFdID8/ICcxJyksXG5cdFx0XHRcdGZvcm1hdDogc3BsaXRbc3BsaXQubGVuZ3RoIC0gMl0sXG5cdFx0XHRcdHNyYzogdmFsdWUsXG5cdFx0XHR9O1xuXHRcdH0sXG5cdH0sXG5cblx0bG9hZGVyOiB7XG5cdFx0ZXh0ZW5zaW9uOiB7XG5cdFx0XHR0eXBlOiBFeHRlbnNpb25UeXBlLkxvYWRQYXJzZXIsXG5cdFx0XHRwcmlvcml0eTogTG9hZGVyUGFyc2VyUHJpb3JpdHkuTm9ybWFsLFxuXHRcdFx0bmFtZTogJ3NwaW5lVGV4dHVyZUF0bGFzTG9hZGVyJyxcblx0XHR9LFxuXG5cdFx0dGVzdCAodXJsOiBzdHJpbmcpOiBib29sZWFuIHtcblx0XHRcdHJldHVybiBjaGVja0V4dGVuc2lvbih1cmwsICcuYXRsYXMnKTtcblx0XHR9LFxuXG5cdFx0YXN5bmMgbG9hZCAodXJsOiBzdHJpbmcpOiBQcm9taXNlPFJhd0F0bGFzPiB7XG5cdFx0XHRjb25zdCByZXNwb25zZSA9IGF3YWl0IERPTUFkYXB0ZXIuZ2V0KCkuZmV0Y2godXJsKTtcblxuXHRcdFx0Y29uc3QgdHh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuXG5cdFx0XHRyZXR1cm4gdHh0O1xuXHRcdH0sXG5cblx0XHR0ZXN0UGFyc2UgKGFzc2V0OiB1bmtub3duLCBvcHRpb25zOiBSZXNvbHZlZEFzc2V0KTogUHJvbWlzZTxib29sZWFuPiB7XG5cdFx0XHRjb25zdCBpc0V4dGVuc2lvblJpZ2h0ID0gY2hlY2tFeHRlbnNpb24ob3B0aW9ucy5zcmMgYXMgc3RyaW5nLCAnLmF0bGFzJyk7XG5cdFx0XHRjb25zdCBpc1N0cmluZyA9IHR5cGVvZiBhc3NldCA9PT0gJ3N0cmluZyc7XG5cblx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoaXNFeHRlbnNpb25SaWdodCAmJiBpc1N0cmluZyk7XG5cdFx0fSxcblxuXHRcdHVubG9hZCAoYXRsYXM6IFRleHR1cmVBdGxhcykge1xuXHRcdFx0YXRsYXMuZGlzcG9zZSgpO1xuXHRcdH0sXG5cblx0XHRhc3luYyBwYXJzZSAoYXNzZXQ6IFJhd0F0bGFzLCBvcHRpb25zOiBSZXNvbHZlZEFzc2V0LCBsb2FkZXI6IExvYWRlcik6IFByb21pc2U8VGV4dHVyZUF0bGFzPiB7XG5cdFx0XHRjb25zdCBtZXRhZGF0YTogSVNwaW5lQXRsYXNNZXRhZGF0YSA9IG9wdGlvbnMuZGF0YSB8fCB7fTtcblx0XHRcdGxldCBiYXNlUGF0aCA9IHBhdGguZGlybmFtZShvcHRpb25zLnNyYyBhcyBzdHJpbmcpO1xuXG5cdFx0XHRpZiAoYmFzZVBhdGggJiYgYmFzZVBhdGgubGFzdEluZGV4T2YoJy8nKSAhPT0gYmFzZVBhdGgubGVuZ3RoIC0gMSkge1xuXHRcdFx0XHRiYXNlUGF0aCArPSAnLyc7XG5cdFx0XHR9XG5cblx0XHRcdC8vIFJldHZhbCBpcyBnb2luZyB0byBiZSBhIHRleHR1cmUgYXRsYXMuIEhvd2V2ZXIgd2UgbmVlZCB0byB3YWl0IGZvciBpdCdzIGNhbGxiYWNrIHRvIHJlc29sdmUgdGhpcyBwcm9taXNlLlxuXHRcdFx0Y29uc3QgcmV0dmFsID0gbmV3IFRleHR1cmVBdGxhcyhhc3NldCk7XG5cblx0XHRcdC8vIElmIHRoZSB1c2VyIGdhdmUgbWUgb25seSBvbmUgdGV4dHVyZSwgdGhhdCBvbmUgaXMgYXNzdW1lZCB0byBiZSB0aGUgXCJmaXJzdFwiIHRleHR1cmUgaW4gdGhlIGF0bGFzXG5cdFx0XHRpZiAobWV0YWRhdGEuaW1hZ2VzIGluc3RhbmNlb2YgVGV4dHVyZVNvdXJjZSB8fCB0eXBlb2YgbWV0YWRhdGEuaW1hZ2VzID09PSAnc3RyaW5nJykge1xuXHRcdFx0XHRjb25zdCBwaXhpVGV4dHVyZSA9IG1ldGFkYXRhLmltYWdlcztcblxuXHRcdFx0XHRtZXRhZGF0YS5pbWFnZXMgPSB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBUZXh0dXJlU291cmNlIHwgc3RyaW5nPjtcblx0XHRcdFx0bWV0YWRhdGEuaW1hZ2VzW3JldHZhbC5wYWdlc1swXS5uYW1lXSA9IHBpeGlUZXh0dXJlO1xuXHRcdFx0fVxuXG5cdFx0XHQvLyB3ZSB3aWxsIHdhaXQgZm9yIGFsbCBwcm9taXNlcyBmb3IgdGhlIHRleHR1cmVzIGF0IHRoZSBzYW1lIHRpbWUgYXQgdGhlIGVuZC5cblx0XHRcdGNvbnN0IHRleHR1cmVMb2FkaW5nUHJvbWlzZXM6IFByb21pc2U8YW55PltdID0gW107XG5cblx0XHRcdC8vIGZpbGwgdGhlIHBhZ2VzXG5cdFx0XHRmb3IgKGNvbnN0IHBhZ2Ugb2YgcmV0dmFsLnBhZ2VzKSB7XG5cdFx0XHRcdGNvbnN0IHBhZ2VOYW1lID0gcGFnZS5uYW1lO1xuXHRcdFx0XHRjb25zdCBwcm92aWRlZFBhZ2UgPSBtZXRhZGF0YT8uaW1hZ2VzID8gbWV0YWRhdGEuaW1hZ2VzW3BhZ2VOYW1lXSA6IHVuZGVmaW5lZDtcblxuXHRcdFx0XHRpZiAocHJvdmlkZWRQYWdlIGluc3RhbmNlb2YgVGV4dHVyZVNvdXJjZSkge1xuXHRcdFx0XHRcdHBhZ2Uuc2V0VGV4dHVyZShTcGluZVRleHR1cmUuZnJvbShwcm92aWRlZFBhZ2UpKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRlbHNlIHtcblx0XHRcdFx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuXHRcdFx0XHRcdGNvbnN0IHVybDogc3RyaW5nID0gcHJvdmlkZWRQYWdlID8/IHBhdGgubm9ybWFsaXplKFsuLi5iYXNlUGF0aC5zcGxpdChwYXRoLnNlcCksIHBhZ2VOYW1lXS5qb2luKHBhdGguc2VwKSk7XG5cblx0XHRcdFx0XHRjb25zdCBhc3NldHNUb0xvYWRJbiA9IHtcblx0XHRcdFx0XHRcdHNyYzogdXJsLFxuXHRcdFx0XHRcdFx0ZGF0YToge1xuXHRcdFx0XHRcdFx0XHQuLi5tZXRhZGF0YS5pbWFnZU1ldGFkYXRhLFxuXHRcdFx0XHRcdFx0XHRhbHBoYU1vZGU6IHBhZ2UucG1hID8gJ3ByZW11bHRpcGxpZWQtYWxwaGEnIDogJ3ByZW11bHRpcGx5LWFscGhhLW9uLXVwbG9hZCdcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9O1xuXG5cdFx0XHRcdFx0Y29uc3QgcGl4aVByb21pc2UgPSBsb2FkZXIubG9hZDxUZXh0dXJlPihhc3NldHNUb0xvYWRJbikudGhlbigodGV4dHVyZSkgPT4ge1xuXHRcdFx0XHRcdFx0cGFnZS5zZXRUZXh0dXJlKFNwaW5lVGV4dHVyZS5mcm9tKHRleHR1cmUuc291cmNlKSk7XG5cdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHR0ZXh0dXJlTG9hZGluZ1Byb21pc2VzLnB1c2gocGl4aVByb21pc2UpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGF3YWl0IFByb21pc2UuYWxsKHRleHR1cmVMb2FkaW5nUHJvbWlzZXMpO1xuXG5cdFx0XHRyZXR1cm4gcmV0dmFsO1xuXHRcdH0sXG5cdH0sXG59IGFzIEFzc2V0RXh0ZW5zaW9uPFJhd0F0bGFzIHwgVGV4dHVyZUF0bGFzLCBJU3BpbmVBdGxhc01ldGFkYXRhPjtcblxuZXh0ZW5zaW9ucy5hZGQoc3BpbmVUZXh0dXJlQXRsYXNMb2FkZXIpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElTcGluZUF0bGFzTWV0YWRhdGEge1xuXHQvLyBJZiB5b3UgYXJlIGRvd25sb2FkaW5nIGFuIC5hdGxhcyBmaWxlLCB0aGlzIG1ldGFkYXRhIHdpbGwgZ28gdG8gdGhlIFRleHR1cmUgbG9hZGVyXG5cdGltYWdlTWV0YWRhdGE/OiBhbnk7XG5cdC8vIElmIHlvdSBhbHJlYWR5IGhhdmUgYXRsYXMgcGFnZXMgbG9hZGVkIGFzIHBpeGkgdGV4dHVyZXNcblx0Ly8gYW5kIHdhbnQgdG8gdXNlIHRoYXQgdG8gY3JlYXRlIHRoZSBhdGxhcywgeW91IGNhbiBwYXNzIHRoZW0gaGVyZVxuXHRpbWFnZXM/OiBUZXh0dXJlU291cmNlIHwgc3RyaW5nIHwgUmVjb3JkPHN0cmluZywgVGV4dHVyZVNvdXJjZSB8IHN0cmluZz47XG59XG4iXX0=